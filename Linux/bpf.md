BPF 全称是 「Berkeley Packet Filter」，翻译过来是 「伯克利包过滤器」。

经典 BPF 于 1997 年进入 Linux 内核版本 2.1.75，是一个功能有限的虚拟机。它有两个寄存器，一个由 16 个内存槽位组成的临时存储区域和一个程序计数器，用于在内核实现高性能的网络数据包过滤。

而后 Alexei Starovoitov 创造了扩展版 BPF（eBPF）。这是 20 年来 BPF 的第一次重大更新，此举也将 BPF 扩展为一个通用的虚拟机。扩展版的 BPF 中增加了更多寄存器，并将字长从 32 位增至 64 位，创建了灵活的 BPF 映射型存储（map），并允许调用一些受限制的内核功能。同时，eBPF 被设计为可以使用即时编译（JIT），机器指令与寄存器可以一对一映射。

BPF 虚拟机的实现既包括一个解释器，又包括一个 JIT 编译器 ：JIT 编译器负责生成处理器可直接执行的机器指令。验证器会拒绝那些不安全的操作，这包括针对无界循环的检查 ：BPF 程序必须在有限的时间内完成。

> “Super powers have finally come to Linux” — Brendan Gregg

- BPF Hooks
  从文件打开、创建 TCP 链接、Socket 链接到发送系统消息等几乎所有的系统调用，加上用户空间的各种动态信息，都能加载 BPF 程序，可以说是无所不能。
- BPF Map
  可以利用 BPF Map 持久化数据，在不丢失重要数据的同时，更新 BPF 程序逻辑，实现在不同程序之间共享信息，在收集统计信息或指标等场景下，尤其有用。
- BPF Helper Function
  操作 BPF 程序和 BPF Map 的工具类函数，隐藏后端的内核函数的变化，形成稳定 API 接口。

https://ebpf.io
